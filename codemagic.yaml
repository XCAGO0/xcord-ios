workflows:
  ios-workflow:
    name: iOS Workflow
    instance_type: mac_mini_m1
    max_build_duration: 60
    environment:
      vars:
        BUNDLE_ID: "com.xcago.xcord"
      flutter: stable
      xcode: latest
      cocoapods: default
    scripts:
      - name: Clean Git conflicts
        script: |
          find . -type f -name "*.dart" -exec sed -i '' -e '/^<<<<<<< HEAD$/,/^>>>>>>> /d' {} +
          find . -type f -name "*.yaml" -exec sed -i '' -e '/^<<<<<<< HEAD$/,/^>>>>>>> /d' {} +
          
      - name: Clean project
        script: |
          flutter clean
          rm -rf ios
          rm -rf build
          rm -rf Pods
          rm -rf .symlinks
          rm -rf Podfile.lock
          
      - name: Get Flutter packages
        script: flutter pub get
        
      - name: Create iOS project
        script: |
          flutter create . --platforms=ios
          cd ios
          rm -f Podfile
          
      - name: Set up Podfile
        script: |
          cd ios
          cat > Podfile << 'EOL'
          platform :ios, '12.0'
          
          # Add this line to prevent warnings
          install! 'cocoapods', :deterministic_uuids => false
          
          target 'Runner' do
            use_frameworks!
            use_modular_headers!
            
            # Firebase pods
            pod 'Firebase/Core'
            pod 'Firebase/Database'
            pod 'Firebase/Auth'
            pod 'Firebase/Analytics'
            
            # Flutter pods
            flutter_install_all_ios_pods File.dirname(File.realpath(__FILE__))
          end
          
          post_install do |installer|
            installer.pods_project.targets.each do |target|
              flutter_additional_ios_build_settings(target)
              target.build_configurations.each do |config|
                config.build_settings['ENABLE_BITCODE'] = 'NO'
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '12.0'
                # Fix for Firebase
                config.build_settings['BUILD_LIBRARY_FOR_DISTRIBUTION'] = 'YES'
                config.build_settings['CLANG_ALLOW_NON_MODULAR_INCLUDES_IN_FRAMEWORK_MODULES'] = 'YES'
                config.build_settings['ONLY_ACTIVE_ARCH'] = 'YES'
              end
            end
          end
          EOL
          
      - name: Install pods
        script: |
          cd ios
          pod repo update
          pod install --repo-update
          
      - name: Build iOS
        script: |
          flutter build ios --debug --no-codesign
          
    artifacts:
      - build/ios/iphoneos/Runner.app
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    publishing:
      email:
        recipients:
          - xcord@xcago.com  